{% extends 'base.html' %}
{% block content %}
<div style="background-color: #E0F2F7; padding: 20px; border-radius: 10px;"><div style="background-color: #9dcce7; padding: 20px; border-radius: 10px;">

<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-md-12">

      <!-- Record Sale Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h3 class="text-center mb-4">Record Sales - {{ dairy.name }}</h3>

          <form method="post" class="row g-3">

            <!-- ✅ Product Dropdown -->
            <div class="col-md-4 col-sm-12">
              <label class="form-label">Product</label>
              <select name="product_id" id="productSelect" class="form-select" required onchange="refreshPrice()">
                <option value="">-- Select Product --</option>
                {% for p in products %}
                  <option value="{{ p.id }}" data-price="{{ p.sell_price }}">{{ p.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- ✅ Quantity -->
            <div class="col-md-2 col-sm-6">
              <label class="form-label">Qty</label>
              <input name="qty" class="form-control" required>
            </div>

            <!-- ✅ Selling Price (readonly) -->
            <div class="col-md-2 col-sm-6">
              <label class="form-label">Selling Price</label>
              <input type="text" id="sellingPrice" name="selling_price" class="form-control" readonly>
            </div>

            <!-- ✅ Date -->
            <div class="col-md-2 col-sm-6">
              <label class="form-label">Date</label>
              <input type="date" name="date" class="form-control" value="{{ today }}" required>
            </div>

            <!-- ✅ Remarks -->
            <div class="col-md-2 col-sm-6">
              <label class="form-label">Remarks</label>
              <input id="remarks" name="remarks" class="form-control" oninput="refreshPrice()">

            </div>

            <!-- ✅ Submit -->
            <div class="col-12 text-end">
              <button class="btn btn-primary">Record Sale</button>
            </div>

          </form>
        </div>
      </div>

      <!-- ✅ Recent Sales Table -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="text-center mb-4">Recent Sales</h5>
          <div class="table-responsive">
            <table class="table table-bordered table-hover text-center align-middle">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Product</th>
                  <th>Qty</th>
                  <th>Price</th>
                  <th>Amount</th>
                  <th>Remarks</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for s in sales %}
                <tr>
                  <td>{{ s.date }}</td>
                  <td>{{ s.product.name }}</td>
                  <td>{{ s.qty }}</td>
                  <td>₹{{ '%.2f'|format(s.selling_price) }}</td>
                  <td>₹{{ '%.2f'|format(s.qty * s.selling_price) }}</td>
                  <td>{{ s.remarks }}</td>
                  <td class="d-flex justify-content-center gap-2">
                    <a class="btn btn-sm btn-primary" href="{{ url_for('edit_sale', sid=s.id) }}">Edit</a>
                    <form method="post" action="{{ url_for('delete_sale', sid=s.id) }}" 
                          onsubmit="return confirm('Are you sure you want to delete this sale entry?')">
                      <button class="btn btn-sm btn-danger">Delete</button>
                    </form>
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="7" class="text-center text-muted">No sales recorded yet</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ✅ JavaScript Logic -->
<script>
  function refreshPrice() {
    const select = document.getElementById("productSelect");
    const remarks = document.getElementById("remarks").value.toLowerCase().trim();
    const sellingPriceField = document.getElementById("sellingPrice");
  
    const selectedOption = select.options[select.selectedIndex];
    const price = selectedOption ? selectedOption.getAttribute("data-price") : '';
  
    // If remarks contain "return" → price = 0
    if (remarks.includes("return")) {
      sellingPriceField.value = 0;
    } else {
      sellingPriceField.value = price;
    }
  }
  </script>
  
  

{% endblock %}
